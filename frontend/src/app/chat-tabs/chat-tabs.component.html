<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content new-chat-modal">
      <form (submit)="handleNewChat($event)">
        <div class="modal-header new-chat-modal-header">
          <h5 class="modal-title text-black" id="newChatModalLabel">New Chat</h5>
          <button
            type="button"
            class="btn-close ms-auto"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        
        <div class="modal-body">
          <div class="mb-3">
            <label for="chatFile" class="form-label"> 
              Select a file to start a new chat
            </label>
            <input
              type="file"
              class="form-control"
              id="chatFile"
              (change)="onFileSelected($event)"
              required
            />
          </div>
        </div>

        <div class="modal-footer new-chat-modal-footer">
          <button
            type="submit"
            class="btn create-chat-btn"
            [disabled]="!selectedFile"
          >
            Create Chat
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Confirm Close Modal -->
<div class="modal fade" id="confirmCloseModal" tabindex="-1" aria-labelledby="confirmCloseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content confirm-close-modal">
      <div class="modal-header confirm-close-header">
        <h5 class="modal-title" id="confirmCloseModalLabel">Eliminate Chat</h5>
      </div>
      <div class="modal-body confirm-close-body">
        This action will permanently close the chat and remove all associated messages. This cannot be undone.
      </div>
      <div class="modal-footer confirm-close-footer">
        <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn confirm-btn" id="confirmCloseBtn" (click)="confirmClose()">Eliminate</button>
      </div>
    </div>
  </div>
</div>


<!-- Chat Tabs -->
<div class="tab-bar-wrapper">
  <ul class="nav nav-tabs mb-3 flex-wrap" *ngIf="chats.length">
    <ng-container *ngFor="let chat of chats; let i = index">
      <li class="nav-item" [ngClass]="{ 'inactive-tab': i !== selected }">
        <a
          href="javascript:void(0)"
          class="nav-link"
          [ngClass]="{ 'active': i === selected }"
          (click)="choose(i)"
          [attr.title]="chat.title || ('Chat ' + chat.id)"
        >
          <span class="text-truncate me-1">{{ chat.title || ('Chat ' + chat.id) }}</span>

          <button
            type="button"
            class="btn-close ms-2"
            aria-label="Close"
            (click)="prepareToClose(i, $event)"
          ></button>

        </a>
      </li>
  
      <li
        class="nav-item separator"
        [ngClass]="{ 'visible': isSeparatorNeeded(i), 'invisible': !isSeparatorNeeded(i) }"
      >
        |
      </li>

    </ng-container>
  
    <li class="nav-item">
      <a
        href="javascript:void(0)"
        class="nav-link text-center new-tab-button fw-bold fs-4"
        title="Add New Chat"
        (click)="openNewChatModal()"
      >+</a>
    </li>
  </ul>   
</div>

<!-- Chat Container -->
<div *ngIf="chats.length" class="chat-container">

  <!-- Messages -->
  <div #messageContainer class="messages-container">
    <div class="messages-inner">
      <div
        *ngFor="let msg of chats[selected]?.messages"
        class="d-flex message-wrapper"
        [ngClass]="{
          'justify-content-end': msg.role === 'user',
          'justify-content-start': msg.role !== 'user'
        }"
      >
        <div
          class="shadow-sm"
          [ngClass]="{
            'user-message': msg.role === 'user',
            'ai-message': msg.role !== 'user'
          }"
        >
          <div>{{ msg.content }}</div>
        </div>
      </div>
    </div>

    <div *ngIf="chats[selected]?.messages?.length === 0" class="empty-chat-hint">
      <p>Write your first message!</p>
    </div>    
    
  </div>

  <!-- Message Input -->
  <div class="chat-input-wrapper">
    <form (submit)="sendMessage()" class="d-flex align-items-end gap-2 w-100">
      <div class="position-relative flex-grow-1">
        <textarea
          #textarea
          [(ngModel)]="newMessage"
          name="message"
          class="form-control chat-textarea pe-5"
          placeholder="Ask anything here"
          rows="1"
          required
          autocomplete="off"
          (keydown)="handleKeyDown($event)"
        ></textarea>
    
        <!-- File upload button -->
        <button
          type="button"
          class="btn p-0 border-0 bg-transparent position-absolute"
          (click)="openFilePicker()"
          aria-label="Attach file"
          title="Attach file"
          style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"
        >
          <img src="assets/images/clip.png" alt="Attach" style="width: 20px; height: 20px;" />
        </button>
      </div>

      <!-- Send button -->
      <button
        type="submit"
        class="btn p-0 border-0 bg-transparent d-flex align-items-center justify-content-center"
        style="align-self: center; height: 100%; margin-left: 10px;"
      >
        <img src="assets/images/send.png" alt="Send" style="width: 35px; height: 35px;" />
      </button>

    </form>
  </div>
</div>

<!-- No Chats -->
<div *ngIf="!chats.length" class="d-flex flex-column align-items-center justify-content-center text-center py-5">
  <!-- Robot image -->
  <img
    src="assets/images/robotSleeping.png"
    alt="Robot sleeping"
    style="width: 180px; height: auto; margin-bottom: 1rem;"
  />

  <p class="mb-3 text-muted" style="font-size: 1.1rem;">You don't have any chats yet.</p>
  
  <div style="margin-top: 60px;">
    <button
      class="btn p-0 border-0 bg-transparent"
      (click)="openNewChatModal()"
      title="Start a new chat"
      style="cursor: pointer;"
    >
      <img src="assets/images/add.png" alt="Add chat" style="width: 65px; height: 65px;" />
    </button>

    <p class="mt-2" style="font-size: 0.9rem; color: #803cf2;">Start a new chat</p>
  </div>
</div>




<!-- Hidden File Input -->
<input
  type="file"
  id="fileInput"
  accept=".pdf"
  style="display: none"
  (change)="onChatFileSelected($event)"
/>

<!-- File Preview -->
<div *ngIf="pendingUploadFileName" class="file-preview">
  ðŸ“Ž Attached: {{ pendingUploadFileName }}
</div>
