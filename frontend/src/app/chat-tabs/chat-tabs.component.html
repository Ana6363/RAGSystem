
<!-- New Chat Modal -->
<div
  class="modal fade"
  id="newChatModal"
  tabindex="-1"
  aria-labelledby="newChatModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form (submit)="handleNewChat($event)">
        <div class="modal-header new-chat-modal-header">
          <h5 class="modal-title" id="newChatModalLabel">Start New Chat</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="chatFile" class="form-label fw-semibold">
              Select a file to start the chat
            </label>
            <input
              type="file"
              class="form-control"
              id="chatFile"
              (change)="onFileSelected($event)"
              required
            />
          </div>
        </div>

        <div class="modal-footer bg-light border-top">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!selectedFile"
          >
            Create Chat
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Close Modal -->
<div
  class="modal fade"
  id="confirmCloseModal"
  tabindex="-1"
  aria-labelledby="confirmCloseModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content border-0">
      <div class="modal-header bg-danger text-white new-chat-modal-header">
        <h5 class="modal-title" id="confirmCloseModalLabel">
          Confirm Close Chat
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">Are you sure you want to close this chat?</div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger"
          id="confirmCloseBtn"
          (click)="confirmClose()"
        >
          Yes, close chat
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Tabs -->
<div class="tab-bar-wrapper">
  <ul class="nav nav-tabs mb-3 flex-wrap" *ngIf="chats.length">
    <ng-container *ngFor="let chat of chats; let i = index">
      <li class="nav-item" [ngClass]="{ 'inactive-tab': i !== selected }">
        <a
          href="javascript:void(0)"
          class="nav-link"
          [ngClass]="{ 'active': i === selected }"
          (click)="choose(i)"
          [attr.title]="chat.title || ('Chat ' + chat.id)"
        >
          <span class="text-truncate me-1">{{ chat.title || ('Chat ' + chat.id) }}</span>
          <button
            type="button"
            class="btn-close ms-2"
            aria-label="Close"
            (click)="prepareToClose(i, $event)"
          ></button>
        </a>
      </li>
  
      <!-- Always render separator, just hide it if not needed -->
      <li
        class="nav-item separator"
        [ngClass]="{ 'visible': isSeparatorNeeded(i), 'invisible': !isSeparatorNeeded(i) }"
      >
        |
      </li>

    </ng-container>
  
    <li class="nav-item">
      <a
        href="javascript:void(0)"
        class="nav-link text-center text-primary fw-bold fs-4"
        title="Add New Chat"
        (click)="openNewChatModal()"
      >+</a>
    </li>
  </ul>   
</div>

<!-- Chat Container -->
<div *ngIf="chats.length" class="chat-container">

  <!-- Messages -->
  <div #messageContainer class="messages-container">
    <div class="messages-inner">
      <div
        *ngFor="let msg of chats[selected]?.messages"
        class="d-flex message-wrapper"
        [ngClass]="{
          'justify-content-end': msg.role === 'user',
          'justify-content-start': msg.role !== 'user'
        }"
      >
        <div
          class="shadow-sm"
          [ngClass]="{
            'user-message': msg.role === 'user',
            'ai-message': msg.role !== 'user'
          }"
        >
          <div>{{ msg.content }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Input -->
  <div class="chat-input-wrapper">
    <form (submit)="sendMessage()" class="d-flex align-items-end gap-2 w-100">
      <div class="position-relative flex-grow-1">
        <textarea
          #textarea
          [(ngModel)]="newMessage"
          name="message"
          class="form-control chat-textarea pe-5"
          placeholder="Ask anything here"
          rows="1"
          required
          autocomplete="off"
        ></textarea>
    
        <!-- File upload button -->
        <button
          type="button"
          class="btn p-0 border-0 bg-transparent position-absolute"
          (click)="openFilePicker()"
          aria-label="Attach file"
          title="Attach file"
          style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;"
        >
          <img src="assets/images/clip.png" alt="Attach" style="width: 20px; height: 20px;" />
        </button>
      </div>

      <!-- Send button -->
      <button
        type="submit"
        class="btn p-0 border-0 bg-transparent d-flex align-items-center justify-content-center"
        style="align-self: center; height: 100%; margin-left: 10px;"
      >
        <img src="assets/images/send.png" alt="Send" style="width: 35px; height: 35px;" />
      </button>

    </form>
  </div>
</div>

<!-- No Chats -->
<p *ngIf="!chats.length" class="text-muted text-center">No chats available.</p>


<!-- Hidden File Input -->
<input
  type="file"
  id="fileInput"
  accept=".pdf"
  style="display: none"
  (change)="onChatFileSelected($event)"
/>

<!-- File Preview -->
<div *ngIf="pendingUploadFileName" class="file-preview">
  ðŸ“Ž Attached: {{ pendingUploadFileName }}
</div>
