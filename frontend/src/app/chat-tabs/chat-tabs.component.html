<style>
  :root {
    --primary-color: #6f42c1; /* Bootstrap purple */
    --secondary-color: #0d6efd; /* Bootstrap blue */
    --light-purple: #ede7f6;
    --light-blue: #e3f2fd;
    --chat-bg-user: #d1c4e9;
    --chat-bg-ai: #bbdefb;
  }

  .chat-container {
    background: white;
    border-radius: 1rem;
    border: 1px solid var(--light-purple);
  }

  .chat-tab-active {
    background-color: var(--light-purple);
    color: var(--primary-color) !important;
    font-weight: 600;
  }

  .chat-tab-inactive:hover {
    background-color: var(--light-blue);
  }

  .user-message {
    background-color: var(--chat-bg-user);
    color: #4a148c;
  }

  .ai-message {
    background-color: var(--chat-bg-ai);
    color: #0d47a1;
  }

  .file-preview {
    color: #6c757d;
    font-style: italic;
  }
</style>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0">
      <form (submit)="handleNewChat($event)">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="newChatModalLabel">Start New Chat</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="chatFile" class="form-label">Select a file to start the chat</label>
            <input type="file" class="form-control" id="chatFile" (change)="onFileSelected($event)" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100" [disabled]="!selectedFile">Create Chat</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Close Modal -->
<div class="modal fade" id="confirmCloseModal" tabindex="-1" aria-labelledby="confirmCloseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmCloseModalLabel">Confirm Close Chat</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Are you sure you want to close this chat?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmCloseBtn" (click)="confirmClose()">Yes, close chat</button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Tabs -->
<ul class="nav nav-tabs mb-3 flex-nowrap overflow-auto" *ngIf="chats.length">
  <li class="nav-item" *ngFor="let chat of chats; index as i" style="max-width: 300px;">
    <a href="javascript:void(0)"
       class="nav-link chat-tab-inactive d-flex align-items-center justify-content-between"
       [class.chat-tab-active]="i === selected"
       (click)="choose(i)"
       [attr.title]="chat.title || ('Chat ' + chat.id)"
       style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 1.5rem;">
      <span class="text-truncate me-1">{{ chat.title || ('Chat ' + chat.id) }}</span>
      <button type="button" class="btn-close ms-2" aria-label="Close" (click)="prepareToClose(i, $event)"></button>
    </a>
  </li>
  <li class="nav-item">
    <a href="javascript:void(0)" class="nav-link text-center text-primary fw-bold fs-4" title="New Chat" (click)="openNewChatModal()">+</a>
  </li>
</ul>

<!-- Chat Container -->
<div *ngIf="chats.length" class="chat-container p-4 d-flex flex-column" style="height: 70vh;">
  <!-- Messages -->
  <div #messageContainer class="mb-3 overflow-auto flex-grow-1">
    <div *ngFor="let msg of chats[selected]?.messages" class="d-flex mb-3"
         [ngClass]="{
           'justify-content-end': msg.role === 'user',
           'justify-content-start': msg.role !== 'user'
         }">
      <div class="p-3 rounded shadow-sm"
           [ngClass]="{
             'user-message': msg.role === 'user',
             'ai-message': msg.role !== 'user'
           }"
           style="max-width: 75%; white-space: pre-wrap;">
        <div class="small fw-semibold text-capitalize mb-1">{{ msg.role }}</div>
        <div>{{ msg.content }}</div>
      </div>
    </div>
  </div>
</div>

<!-- No Chats -->
<p *ngIf="!chats.length" class="text-muted text-center">No chats available.</p>

<!-- Message Input -->
<form (submit)="sendMessage()" class="d-flex align-items-end gap-2 mt-3">
  <input type="text" [(ngModel)]="newMessage" name="message" class="form-control border-primary"
         placeholder="Type your message here..." required autocomplete="off" />
  <button type="button" class="btn btn-outline-primary" (click)="openFilePicker()">ðŸ“Ž</button>
  <button type="submit" class="btn btn-primary">Send</button>
</form>

<!-- File Input -->
<input type="file" id="fileInput" accept=".pdf" style="display: none;" (change)="onChatFileSelected($event)" />

<!-- File Preview -->
<div *ngIf="pendingUploadFileName" class="mt-2 small file-preview">
  ðŸ“Ž Attached: {{ pendingUploadFileName }}
</div>
